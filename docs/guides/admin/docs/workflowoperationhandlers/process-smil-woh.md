# ProcessSmilWorkflowHandler

## Description

The ProcessSmilWorkflowHandler is used to edit media files using descriptions from a SMIL file
and encode edited recording to multiple formats concurrently using FFmpeg.
The edited video will fade in from black with a fade-out/fade-in transition and a fade out at the end.
The transition duration is a 2 second fade, but it will be configurable in the future.
> TODO: Support transition in the SMIL file (configurable transitions)

The SMIL file is typically generated by the editor or it can be constructed and uploaded. 
It typically contains names of source tracks and a list of selected clips defined by in points and out points in the source tracks.
This workflow creates video clips from these video tracks, contenates the video clips into one video and encodes this video into multiple delivery formats as one ffmpeg operation per smil paramgroup.

This workflow handles each single source flavor selector independently.

eg: Each source selector can have its own set of encoding profiles, target tags and flavors.
The parameters for each configuration, such as flavor are separated into sections by "**;**".
Each source media selector can have its own sets of encoding profile ids (one for each target recording) and target tags,
as well as its own set of target tags and flavors, defined as a common delimited list.
Each source medium is processed to one or multiple formats in one ffmpeg command.

The target media are optionally tagged with the encoding profile ids.

>eg:
><configuration key="source-flavors">*/source</configuration>
>   One source selector means that all the matching recording will be processed the same way.
>
><configuration key="source-flavors">presenter/source**;**presentation/source</configuration>
>   Two different source selectors means that all the matching recordings in the first selector will be processed
>   according to the parameters in the first section and the all the matching recordings in the second selector will
>   be processed according to the parameters in next section.

Each source selector can have only one corresponding section.
If there is only one source selector, but multiple sections in the parameters, then the sections are collapsed
into one and they will apply to all the source flavors in the source selector.

>eg:
><configuration key="target-flavor">*/preview</configuration>
>   All targets are flavored the same way,using the example above, presenter/preview and presentation/preview
>
>eg:
><configuration key="target-tags">engage-streaming,rss,atom**;**engage-download,rss,atom</configuration>
>   Using the example above.
>   presenter/preview is tagged with engage-streaming,rss,atom.
>   presentation/preview is tagged with engage-download,rss,atom.

The use of the semi-colon is optional. If it is absent, there is only one section.

If there is only one section, then the same configuration is applied to all the sources.
If a configuration has the same number of sections as the source, then the configurations for the operation
are taken from the corresponding sections.

Operations on each source section can run on different servers concurrently.

> Note:
>   Each source flavor generates all the target formats in one ffmpeg call by incorporating relevant parts of the encoding profile command.
>   Care must be taken that no complex filters are used in the encoding profiles used for this workflow, as it can cause a conflict.
>   Encoded target recording are distinguished by the suffix, it is important that all the encoding profiles used have distinct suffices or the target tagging can be wrong.

For example, if presenter/work is to encoded with "mp4-low.http,mp4-medium.http" and
presentation/work is to be encoded with "mp4-vga-medium,mp4-medium.http".
The target flavors are presenter/delivery and presentation/delivery respectly, and all are tagged "engage, archive".
All target media are additionally tagged with encoding profiles.

It will look like the following.

## Parameter Table

|configuration keys | example                     | description                                                         |
|-------------------|-----------------------------|---------------------------------------------------------------------|
|smil-flavor        | smil/smil                   | Specifies the flavor of the new media                               |
|source-flavors     | presenter/work**;**presentation/work  | Which media should be encoded                               |
|target-flavors     | */delivery                  | Specifies the flavor of the new media                               |
|target-tags        | engage,archive              | Specifies the tags of the new media                                 |
|encoding-profiles  | mp4-low.http,mp4-medium.http**;**mp4-vga-medium,mp4-medium.http | Specifies the encoding profiles to use for each source flavor       |
|tag-with-profile   | true (default to false)     | target medium are tagged with coresponding encoding profile Id      |

	 
 
## Operation Example

    <operation
        id="process-smil"
        fail-on-error="true"
        exception-handler-workflow="error"
        description="Encoding presenter (camera) video to Flash download">
        <configurations>
            <configuration key="smil-flavor">smil/cutting</configuration>
            <configuration key="source-flavors">presenter/work;presentation/work</configuration>
            <configuration key="target-flavors">*/delivery</configuration>
            <configuration key="target-tags">engage,archive</configuration>
            <configuration key="encoding-profiles">mp4-low.http,mp4-medium.http*;*mp4-vga-medium,mp4-medium.http</configuration>
            <configuration key="tag-with-profile">true</configuration>
        </configurations>
    </operation>
